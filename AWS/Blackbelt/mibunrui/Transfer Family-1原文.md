

AWS Transfer Family【AWS Black Belt】
https://www.youtube.com/watch?v=neeSpQzb9dA


AWS Transfer Family【AWS Black Belt】文字起こし資料
1. はじめに
AWS ブラックベルト オンライン セミナーへようこそ。本セッションでは AWS Transfer Family の FTP、FTPS、SFTP によるデータ転送に着目してお話ししたいと思います 1。AWS ブラックベルト オンライン セミナーとは、サービス別、ソリューション別、業種別などのテーマに分けて Amazon Web Services Japan 合同会社が提供するオンラインセミナーシリーズとなっております 1。
内容について注意点がございます。本資料では資料作成時点のサービス内容および価格についてご説明しています。最新の情報は AWS 公式ウェブサイトをご確認ください 1。自己紹介をさせていただきます。佐藤深夜と申します。普段は保険業界のお客様に対して技術的なご支援をしております。好きな AWS サービスは Amazon FSx シリーズと Amazon Simple Storage Service (S3) です 1。
本セミナーの対象となる方と目標についてお話しします。まず AWS Transfer Family の全体像を知りたい方、そして FTP、FTPS、SFTP を用いたファイル転送機能を知りたい方が対象です 1。このセミナーでの目標は、AWS Transfer Family がどのようなサービスか説明できるようになること、そして各プロトコルを用いたファイル転送機能をしっかり理解することです 1。なお、本セミナーではワークフローやイベント通知、AWS Transfer Family Web Apps、AS2、SFTP AS2 コネクターなどの応用機能については取り扱いませんのでご注意ください 1, 2。
2. AWS Transfer Family の概要
アジェンダに沿って、まずは AWS Transfer Family の概要についてお話しします 2。まず、クラウドへファイルを転送するケースについて考えてみましょう。スケーラブルなコンピューティング機能の利用、AI/ML やアナリティクスによるデータ活用、他企業とのデータコラボレーションなどが挙げられます 2。
クラウドへのファイル転送が増えたことで、マネージドファイルトランスファー (MFT) と呼ばれるものが注目されています 2。MFT は FTP を含む複数の転送プロトコルを統合した包括的なファイル転送管理プラットフォームです 2。特徴として、ID プロバイダーと連携した認証、ファイルの暗号化、受信後の他ストレージへの転送、AS2 や Web アクセスのサポートなど、安全で信頼性の高いファイル転送が実現できます 2。これにより、ビジネス・クリティカルなニーズを満たすデータ交換が可能となります 2。
しかし、従来の MFT には課題も存在します。ハードウェアとソフトウェアの運用管理、キャパシティやパフォーマンスのメンテナンス、24時間365日の高可用性とスケールの確保、さらにエンドユーザーのアクセス管理や DDoS 攻撃対策などのセキュリティ面、そして使いやすさも重要です 2, 3。
これら MFT の課題に対して、AWS Transfer Family が解決策を提示します 3。AWS Transfer Family を用いることで、Amazon S3 と Amazon Elastic File System (EFS) へ、FTP、SFTP、FTPS プロトコルを用いてファイルを転送できます 3。さらに AS2 や Web アクセスにも対応しており、フルマネージドで高可用な MFT サービスを提供します 3。ログ、監査、アクセス制限、暗号化などの豊富なセキュリティ機能も備わっています 3。
また、転送したデータはそのまま AWS 上で活用でき、既存の FTP コマンドを利用できるため、アプリへの影響が少なく簡単に設定が可能です 3。
3. 全体像とプロトコル
AWS Transfer Family のデータ転送の全体像として、スクリプトやコマンドを使用してエンドポイントへファイルを転送し、そのイベントを他のサービスへ送信したり、保存前にファイルを処理したりすることが可能です 3, 4。また、保存したデータを外部の SFTP サーバーへ送信することもできます 4。
AWS Transfer Family では、利用するプロトコルに応じてサーバーとエンドポイントが自動的に作成・管理されます 4。利用できるプロトコルは以下の通りです 4：
FTP (File Transfer Protocol): ファイル送信に関するプロトコルですが、データチャンネルとコマンド管理チャンネルが暗号化されていないため注意が必要です 4。
FTPS (File Transfer Protocol over SSL): FTP に SSL/TLS を導入し、2つのチャンネルを暗号化したものです 4。
SFTP (Secure Shell File Transfer Protocol): SSH によるセキュリティ機能を実装してファイルを転送します。1つのチャンネルのみを使用します 4。
AWS Transfer Family はデータ転送に関するマネージドサービスです 4。オンプレミスや EC2 で FTP サーバーを構築する場合と比較して、ハードウェア・ソフトウェアの運用、OS のパッチ適用、可用性や拡張性の管理を AWS が行うため、利用者はファイル転送業務に集中できます 4, 5。
4. セキュリティと AWS サービス連携
安全なファイル転送のためのセキュリティ機能として、ID プロバイダーとの連携、エンドポイントタイプや暗号化アルゴリズムの選択、Amazon S3 利用時の AWS IAM 認証、Amazon EFS 利用時の POSIX 認証によるアクセス制御、保存時のデータ暗号化などが提供されています 5。
AWS サービスとの連携により、アップロード後のデータレイク活用や、イベントを検知してアプリケーションへ通知することも可能です 5。
5. 利用のステップとコスト
AWS Transfer Family は 3ステップで準備が整います 5：
プロトコルの選択（これに応じてサーバー・エンドポイントが起動します）。
送信先の Amazon S3 バケットか Amazon EFS ファイル共有を選択。
ユーザーの設定。既存のコマンドを利用できるため、アプリケーションへの影響を最小限に抑えられます 6。
コスト体系については、各プロトコルが有効となっている時間に対するサーバーエンドポイント料金と、データのアップロードおよびダウンロードに対する料金が発生します 6。SFTP と FTPS の両方が有効な場合は、それぞれに対して課金されます 6。
6. アクセス管理機能
ユーザーはエンドポイントへアクセスしてファイルを転送しますが、その際の ID プロバイダーを要件に応じて選択できます 6。転送先が S3 の場合は IAM 認証、EFS の場合は POSIX 認証を設定します 6。また、ユーザーごとにアクセス先ディレクトリを設定可能です 6。
管理できる ID プロバイダーは3つのタイプがあります 6, 7：
AWS Transfer Family マネージドなユーザー管理: SFTP のみ対応、認証はキーベースのみです 7。
AWS Directory Service: FTP/FTPS/SFTP に対応、認証はパスワードのみです 7, 8。
カスタム ID プロバイダー (API Gateway や Lambda): 全プロトコルに対応、キーベースとパスワードの両方、またはそのいずれかを設定可能です 7。
ストレージへのアクセス制御
Amazon S3 への転送例では、ユーザー名、IAM ロール、および セッションポリシーを指定します 7。セッションポリシーを用いることで、ユーザーごとにアクセスさせたいバケットやディレクトリを動的に、かつきめ細やかに定義できます 7, 9。
ホームディレクトリの設定では、特定のバケットやフォルダーを選択し、「制限付き」にチェックを入れることで、ユーザーのアクセスをそのディレクトリ内に限定できます 9。ただし、この制限付き設定は自動生成されたセッションポリシーとは併用できない点に注意が必要です 9。
Amazon EFS への転送例では、ユーザー名、POSIX 認証情報（ディレクトリ・ファイル単位の制御用）、および IAM ロール（マウントやルート権限用）を設定します 8, 9。
AWS Directory Service 利用時の注意
サポートされるものとして AWS Managed Microsoft AD と、AD コネクター経由のオンプレミス/EC2 上の Active Directory があります 8。一方で、Simple AD、多要素認証 (MFA)、クロスリージョンレプリケート先、別リージョン・別アカウントの AD は利用できません 8。また、ユーザーとグループのレルムが一致しない場合も認証ができません 8, 10。
7. サーバーエンドポイントタイプ
サーバーには3つのタイプがあります 10：
パブリック (Public): インターネット経由でアクセス、SFTP 対応。IP 固定や許可リストには非対応です 10。
VPC インターネットフェーシング (VPC Internet-facing): インターネット経由、FTPS/SFTP 対応。パブリック・プライベート IP の固定が可能で、セキュリティグループ等による IP 制限ができます 10, 11。
VPC インターナル (VPC Internal): VPC 内部からのアクセスに限定、全プロトコル対応。IP 固定はプライベート IP のみです 10, 11。
いずれのタイプを選択しても、AWS Transfer Family はマネージドサービスであるため、OS レベルでのアクセスはできません 11。
8. 論理ディレクトリ (Logical Directories)
論理ディレクトリ機能では、ユーザーに見せるディレクトリ構造を仮想化（マッピング）できます 11。例えば、S3 の長いパスをルートディレクトリ「/」として見せることが可能です 11。
ホームディレクトリとの違いは以下の通りです 11, 12：
ホームディレクトリ: 接続時のデフォルトディレクトリ。1ユーザー1つ。コンソールで設定可能 11。
論理ディレクトリ: 任意のディレクトリをマッピング。1ユーザー複数設定可能。設定には AWS CLI や CloudFormation が必要（2021年6月時点） 12。
ユースケースとしては、ルートディレクトリの変更によるフルパスの隠蔽、複数のバケットやプレフィックスを横断したディレクトリ構造の作成などが挙げられます 12, 13。
S3 を用いる場合は、0バイトオブジェクトによるレイテンシを低減するためのディレクトリの最適化設定が推奨されます 13。また、S3 はフラットな構造であるため、フォルダとファイルを厳密に区別したい場合は Amazon EFS を検討してください 13。
9. 設定例とデモの解説
設定例として、SFTP サーバーをパブリック、サービスマネージドユーザーで作成する手順が紹介されました 13, 14。
サーバー作成: コンソールからプロトコル、ID プロバイダー、エンドポイントタイプ、ドメイン（S3 等）を選択します 14。
詳細設定: CloudWatch へのログ配信、ワークフロー、暗号化アルゴリズム、サーバーホストキーの設定が可能です 14。既存サーバーからの移行時は、ホストキーを置き換えることでユーザーに通知せず移行できます 14。
属性情報の設定: S3 はオブジェクトストレージのため、SFTP クライアントからの属性変更は通常エラーになりますが、「セットスタット (setstat)」オプションを有効にすることでエラーを回避してアップロードできます 14, 15。タイムスタンプ等の属性情報を維持したい場合は Amazon EFS を使用してください 15。
FTPS 固有設定: TLS セッション再開機能や、ロードバランサー経由の接続を可能にするパッシブモード (PASV) 設定が可能です 15。
ユーザー作成後は、SFTP クライアントから接続し、カレントディレクトリの確認やファイルのアップロードが行えることを確認します 16。ディレクトリを「制限付き」に変更すると、フルパスが見えなくなり、親ディレクトリへの移動も制限されます 16。
10. 考慮事項とまとめ
利用時の考慮点 16, 17：
SCP プロトコルはサポートされません。SCP コマンドを使用する場合は、OpenSSH バージョン 9 以降で SFTP プロトコルを用いるよう設定してください 16。
1接続あたりのセッション数は最大 10 です 16。
アイドルタイムアウトは 1800 秒、クライアント無応答時は 300 秒で切断されます 16。
ファイル名は UTF-8 エンコードが必要です 17。
1つのデータ転送に複数のコネクションを設定しないでください 17。
S3 利用時、ディレクトリのリネーム等はサポートされません 17。
クロスリージョン対応は Amazon S3 のみです 17。
まとめ
AWS Transfer Family は、FTP、FTPS、SFTP プロトコルを使用して Amazon S3 や Amazon EFS へのファイル転送を実現するフルマネージドサービスです 17。セキュア、高可用、スケーラブルな環境を、既存のアプリケーションやワークフローを変更せずに構築できます 17。要件に応じて、プロトコル、エンドポイント、ストレージ、ID プロバイダーを多様な選択肢から選択し、きめ細やかなアクセス制御を行うことが可能です 17。
以上となります。ご清聴ありがとうございました 17, 18。

