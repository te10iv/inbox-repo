
## 1. はじめに

### 1.1 資料に関する注意事項
本資料では、資料作成時点のサービス内容に基づき説明しています。
AWS のサービスは常にアップデートされているため、
最新の情報についてはAWS 公式ウェブサイトをご確認ください。

### セミナーの目的とアジェンダ
- 本セミナーの目標
  - AWS Direct Connect を検討する際に必ず議題に上がる 接続パターン と 冗長構成 について理解していただくこと
- 本セッションでは概要に絞って説明します。
  - より詳細な内容については、最後に紹介するドキュメント、資料、過去の Black Belt 資料をご参照ください。
  - 今後、Direct Connect の詳細編 Black Belt Online セミナーの公開も予定しています。


1. アジェンダ
- AWS Direct Connect の概要
- 接続パターンと冗長構成


## 2.AWS Direct Connect 概要

### サービス概要
- AWS Direct Connect
  - AWS への 専用ネットワーク接続サービス です。
  - インターネットを経由せず、お客様の設備と AWS 間をプライベートネットワーク で接続できます。

- Direct Connect ロケーション
  - Direct Connect の接続ポイントとなるDirect Connect ロケーション は世界中に存在します。
  - 日本では、関東・関西それぞれに複数のロケーションが提供されています。
- サービス提供範囲
  - Direct Connect は、Direct Connect ロケーション内のAWS ルーターから AWS クラウドまで をAWS が提供するサービスです。
  - 一方で、オンプレミスから Direct Connect ロケーション、およびロケーション内の AWS ルーターまでの配線は、キャリアやデータセンター事業者が提供します。

## 3.Direct Connect ロケーション詳細
- Direct Connect ロケーションでは、AWS のルーターとお客様、またはパートナーのルーターを構内配線（クロスコネクト） で接続します。
- 構内配線はデータセンター事業者に依頼し、Meet-Me Room（MMR） を介してパッチパネル接続されます。

- お客様拠点との接続パターン
- 6.1 接続パターンの種類
  - お客様機器をロケーションに設置するパターン
  - オンプレミスとは別回線で接続
  - パートナー機器をロケーションに設置するパターン
  - パートナーサービスを利用
  - パートナー網を経由するパターン
  - 複数拠点への同時接続が可能
  - これらを組み合わせることで、効率的なクラウドへの広域接続を実現します。


## 4.基本ネットワーク用語の補足（正規化）
- VLAN（Virtual LAN）
  - 物理ネットワークを複数の 論理ネットワーク に分割する技術
  - Direct Connect ではVLAN ID により論理分割
- BGP（Border Gateway Protocol）
  - IP ネットワークにおいてIP プレフィックス（CIDR） の経路情報を交換するためのルーティングプロトコル
  - Direct Connect ではオンプレミスと AWS 間の経路交換に使用


## 5.物理接続と論理接続の関係
- 物理接続（Connection）
  - AWS Direct Connect の物理リソースはConnection（接続） と呼ばれます。
    - 専用接続（Dedicated Connection）
      - 単一のユーザー専用
    - ホスト型接続（Hosted Connection）
      - パートナー（回線業者）が確保したConnectionから、利用者に共有する
  - 1G or 10G or 100G or 400G bpsが選べる
- 論理接続（VIF）
  - 物理接続の上に、Virtual Interface（VIF） を作成します。
  - VIF ごとに以下を持ちます。
    - VLAN ID
    - BGP セッション
    - 1 つの Connection に複数の VIF を作成できます。


### 6.VIF の種類
- Private VIF
  - VPCへプライベートIPを介した接続を提供
- Transit VIF
  - VPCへプライベートIPを介した接続を提供
- Public VIF
  - 中国を除くAWSの全リージョンへパブリックIPを介した接続を提供
- 用途・接続先に応じて使い分けます。
- 詳細はこのあと説明。

## 7.接続パターンについて （=VIFと接続サービスの組み合わせ）
- オンプレミスとVPCをプライベートIPで接続したい
  - 接続パターン-1：DXGW(Direct Connect Gateway)の接続
    - VIFの名称：Private VIF
    - 特徴
      - 複数VPC・複数リージョンに接続可能
        - ただし接続できるVPCの数は20個までなので...
          - 20個以上接続したいなら後述のDXGW+TGW接続にすべき。
      - グローバルサービス
      - BGP ピアは 1 つ
      - 関連付けた VPC の CIDR がオンプレミスへ広報される
  - 接続パターン-2：DXGW+TGW接続（DirectConnectGateway+TransitGateway接続）
    - VIFの名称：Transit VIF
    - 特徴
      - より多くのVPC（＝AWS TransitGatewayクオータ）への接続をサポート
      - 通信制御機能を提供し高いスケーラビリティを持つ
      - Transit Gatewayの機能を用い、さまざまなNW拡張が可能
        - トランジットゲートウェイはルーティングテーブルを複数設定できるため複雑な経路設計が可能になります。
        - VPN、SD-WANなどにも対応！！⚪︎⚪︎⚪︎
  - 接続パターン-3： VGW（仮想プライベートゲートウェイ） ＋ Private VIF（従来型）
    - Private VIF を仮想プライベートゲートウェイ（VGW）へ直接接続
    - 単一 VPC 向け
    - 現在は利用機会は減少

- AWS上のパブリックIPに、専用線を介してアクセスしたい
  - 接続パターン：パブリック接続
    - VIFの種類：パブリックVIF
    - 特徴
      - AWS上のパブリックIPのサービスに対して、専用線を介してアクセスが可能

## 8.DXGW(Direct Connect Gateway)の接続

- 構成
オンプレ-BGPピア-DX(プライベートVIF x複数)---DXGW---複数VPC

- ↓再度掲載↓
- 用途：オンプレミスとVPCをプライベートIPで接続したい
  - 接続パターン-1：DXGW(Direct Connect Gateway)＋PrivateVIFを使用
    - VIFの名称：Private VIF
    - Gatewayタイプ：DirectConnectGateway
    - 特徴
      - DXGWはグローバルサービス
        - 特定のリージョンに紐づかない
      - 複数VPC・複数リージョンに接続可能
        - ただし接続できるVPCの数は20個まで（2025/5月時点）なので...
          - 20個以上接続したいなら後述のDXGW+TGW接続にすべき。
      - BGP ピアは 1 つ
      - デフォルトでは、DXGWに紐付けされたVPCのCIDRが全て、オンプレミスへ広報される
        - オンプレミスに広報するPrefixはVPC　CIDR単位でフィルタ可能
      - 複数のVPC、複数のAWSリージョンVPCとの接続が可能
        - VPCは一つでも構わない
      - 自身でプライベートVIFを作成する際には、合わせてゲートウェイタイプ、ダイレクトコネクトゲートウェイを選択する必要があります。
      - パートナー様からVIFを払い出してもらう場合には希望する接続方式を伝えるようにしてください。


## 9. VGW（仮想プライベートゲートウェイ） 接続

- 構成
オンプレDC [お客様ルータ]--- BGPピア ---DC(PrivateVIF) --- VGW --- VPC

- ↓再度掲載↓
- 接続パターン-3： VGW（仮想プライベートゲートウェイ） ＋ Private VIF（従来型）
- プライベートVIFを使用して単一のVPCであれば接続できる
    - Private VIF を仮想プライベートゲートウェイ（VGW）へ直接接続
    - GWタイプ：VGW
    - 欠点
      - 単一VPC向けしか接続できない
    - 現在は利用機会は減少
    - 利用するとしたら。。。  
      - DC自体は追加料金かからないので、VPC1個で増えないならばアリ？？
    - 特別な使用理由というのは例えば
      - ダイレクトコネクトゲートウェイと併用ができない、**AWS VPN Cloudhub**の機能が使いたいといったことが以前は考えられましたが、、、
      - 後述するトランジットゲートウェイやサイトリンクという機能で代替ができるようになってきたため、新規でこの形式をあえて選ぶ理由はない


## 10.Transit VIF + Transit Gateway

- 構成
オンプレ[お客様ルータ]---BGPピア
                      |
           DX(TransitVIF x複数)
                      |
                     DXGW
                      |  |
                      | 【東京L】TGW --- VPC-A(TGW Attachment)
                      |              
                   【大阪L】TGW --- VPC-Ｂ(TGW Attachment)

- ↓再度掲載↓
  - 接続パターン-2：DXGW+TGW接続（DirectConnectGateway+TransitGateway接続）
    - VIFの名称：Transit VIF
    - 特徴
      - より多くのVPC（＝AWS TransitGatewayクオータ）への接続をサポート
      - 通信制御機能を提供し高いスケーラビリティを持つ
      - Transit Gatewayの機能を用い、さまざまなNW拡張が可能
        - トランジットゲートウェイはルーティングテーブルを複数設定できるため複雑な経路設計が可能になります。
        - VPN、SD-WANなどにも対応！！⚪︎⚪︎⚪︎
        - この構成はダイレクトコネクトゲートウェイより多くのVPC接続をサポートし、複数のルートテーブルを使った通信制御も可能で高いスケーラビリティを持っています。
        - またトランジットゲートウェイはVPN接続、SDWAN接続等の機能を持っているため、より複雑なネットワーク要件にも対応できる構成です。
    - 注意点
      - CIDR の明示的広報が必要
        - なお、ダイレクトコネクトゲートウェイを単体で利用した場合と異なり、オンプレミスに対してVPCのCIDRはそのまま候補されませんので、オンプレミスに広報するプレックスリストを設定する必要があります。
      - 追加料金あり
        - トランジットゲートウェイに関わる料金が追加で発生
          - トランジットゲートウェイの機能が戦いたいかどうかでダイレクトコネクトゲートウェイ単体の接続とどちらにするのか判断するのがいいでしょう。



## 11.Public VIF
- 構成
オンプレDC [お客様ルータ(パブリックIPが必要)]--- BGPピア ---DC(PublicVIF) --- VGW --- VPC
　　　　　　　　　　　↑グローバルIPと呼んではダメか？

- ↓再度掲載↓
- AWS上のパブリックIPに、専用線を介してアクセスしたい
  - 接続パターン：パブリック接続
    - VIFの種類：パブリックVIF
    - 特徴
      - AWS上のパブリックIPのサービスに対して、専用線を介してアクセスが可能
        - 中国を除く全のパブリックサービスへの接続性を提供します。
      - 用途
        - AWSサービスのパブリックエンドポイントだったり、AWS上で展開されるSaasサービスへのアクセスが例として上げられます。
    - 注意点
      - BGP 用パブリック IP を顧客側で用意
        - お客様ルーター側でオンレミスのプライベートサイダーを納得する設計にもご注意ください。
        - オンプレ内プライベートIPをピアIPアドレスへNAT(IPマスカレード)する必要がある
      - 約 12,000 経路（2025年5月時点）受信してしまう
        - この数を制限したい場合、お客様ルータ側でBGP Communityを設定して経路フィルター可能
        - ホスト型接続のパートナーのサービスによってはPublicVIFには対応してない場合がごあるので、事前にに利用可否の確認を推奨
      - VPN / SD-WAN 連携
      - 用途補足
        - AWS パブリックサービス　＝「インターネット向けに公開されている IP アドレス」へ接続
          - 例
            - S3 の公開エンドポイント
            - DynamoDB の公開エンドポイント
            - API Gateway、CloudFront（※条件あり）
            - AWS 上の SaaS / マネージドサービス
            - EC2 に付与された Elastic IP（条件あり）



## 補足1.  VIF 混在と Direct Connect Site
10.1 VIF 混在
1 Connection 上に
複数種類の VIF を混在可能
回線効率・コスト最適化・環境分離
10.2 Direct Connect Site
AWS グローバルバックボーンを利用
オンプレミス拠点間通信を実現
最短経路・安定通信


## 11.冗長構成（可用性設計）
11.1 基本方針
単一障害点の排除
複数 Connection
複数ルーター
複数ロケーション
BGP による動的ルーティング
11.2 構成例
11.2.1 デュアルロケーション・シングルリージョン
ロケーション冗長
回線冗長
BGP による自動切替
11.2.2 デュアルロケーション・マルチリージョン
東京・大阪構成
災害対策
最高レベルの可用性