

- 見積（公式）
  - nlbいくつ？　一つ？
  - r53 
    - オンプレのためには必須か
  - 

--------------------------------


▪️大前提：PrivateLinkを使い他社とAWSシステム同士の接続を検討中

現在、複合的なオンプレの金融システムを、AWSリフト中である。

他社（A社とsnowflake社の２社）のシステムも新規に利用することとなり、
PrivateLinkでの接続を検討している。
 (インターネット経由としたくない、コストをかけたくない、などの理由により)
よって、
PrivateLinkについて、設計と見積について複数の質問をしたい。


▪️検討中の構成図　
　・他社との接続はお互い、中継専用アカウントVPCを作り、PrivateLinkによる接続を検討している。
　・AZ障害でも各通信ができるよう、お互いマルチAZを検討している


【自社】
  オンプレミス[メールのMTAがある]
   |
  DirectConnect
   |
   |　　独自WebAPIアカウント（API Gatewayでhttps通信を受け、ジョブシステムにつなぐ）
   |    |      
   |    |      各業務システムごとのAWSアカウント[RDS]
   |    |      |
  [TransitGataway]
   |    |      |
 ------------------
 | 中継専用アカウントのVPC
 |　 AZ-1  AZ-2    # tokyoリージョン
 ------------------
　｜　　     |
　｜　　     | PrivateLink
　｜　　     |
　｜　　【A社】
　｜　　 ------------------
　｜　　　| 中継専用アカウントのVPC
　｜　　　|　 AZ-1  AZ-2    # tokyoリージョン
　｜　　　------------------
　｜
　｜ PrivateLink
　｜
【snowflake社】
　 ------------------
　　| 中継専用アカウントのVPC
　　|　 AZ-1  AZ-2    # tokyoリージョン
　　------------------


▼▼▼通信要件
1) sftp相互連携　※A社とのPrivateLink接続を想定
　・自社の中継アカウントのEC2(SFTPクライアント)　→　A社TransferFamily当てにPUT
　・A社の中継アカウントのSFTPクライアント　→　自社TransferFamily当てにPUT

　・プロトコル：sftp

　・重要な補足事項
　　前提として、
　　自社中継アカウントはマルチAZ構成になっているが、
　　AZ障害がない限りは、AZ１つにAutoScaling有効のEC2(SFTPクライアント)が1台、存在するのみである。
　　これを、Lambdaで監視し、
　　障害あれば、もう一方のAZにEC2クライアントを作成する設計になっている。


2)　独自WebAPIをA社に提供　※A社とのPrivateLink接続を想定
　・A社httpクライアント　　→　自社の中継アカウント　→　のEC2(SFTPクライアント)
　・プロトコル：https

3)　A社のシステムから依頼をかけて自社拠点社員に一斉メール送信　※A社とのPrivateLink接続を想定
　・プロトコル：SMTP

4)　A社のBIツール、DWHシステムを利用 ※A社とのPrivateLink接続を想定
　　・自社の各業務アカウント　→ 中継アカウントのvpce　→　BIツール、DWHシステムを利用
　・確認中
　　・DWH用のプロトコル？
　　・A社Postgresサーバ用のプロトコル？

5)　※snowlake社とのsnowlake利用するための通信    ※PrivateLink接続を想定
　・確認中
　　・httpsは最低限必須と思われる（WebUIログインや利用のため）


▼▼▼参考URLについての注意事項
- 参考URLについては、ハルシネーションを防ぐために以下としてください
  - すべて、AWS公式URLを証左の最優先として探しURL記載してください
  - また、クラウドインテグレータのブログなどあれば併せてURL記載してください
    - クラウドインテグレータ
      - クラスメソッド、アノテーション、サーバワークス、アイレット、スカイアーチ、Beex　などなど
  - 個人ブログもあればURL記載してください


▼▼▼質問

[質問-1]
上記の通信要件は、すべて
PrivateLinkで接続可能か？

また、
PrivateLinkの接続構成はどのような形になるか？

　※PrivateLinkにはNLB必須の接続方式や、
　　PrivateLinkにはNLB必須とせずリソースゲートウェイを使った接続方式などもあると聞いたので、
　　そもそもPrivateLinkの種類や仕様について調査中であり、
　　また、
　　どのような設計とすべきか調査中である。



[質問-2] PrivateLink用リソースの必要個数について
自社中継アカウントの
AZ-1に、IPv4用のNetworkLoadBalancerを1台だけ構築すれば良いでしょうか？
この1台に、
ターゲットグループをすべて設定すればよいでしょうか？

privatelinkはいくつ必要になりますか？
nlbひとつでOKですか?
vpceサービスはいくつ必要ですか？
vpcエンドポイント（＝Interface型vpcエンドポイント）はいくつ必要ですか？


[質問-3]
NetworkLoadBalancer一つ作れば、
IPv4もIPv6も、TCPもUDPもICMPも通信できますか？


[質問-4]
上記通信はすべてPrivateLinkで行うべきですか？
リソースゲートウェイを使った方が安いケースはありますか？


[質問-5]
そもそも、PrivateLinkを使わず、別のサービスを使った方がよいという可能性がありますか？
(安い・可用性が高いなどの理由で)


[質問-6] クロスリージョン間通信の回避について　※構成図で説明してほしい
PrivateLinkでマルチAZ同士で接続するとしたら、
クロスリージョン間通信を発生させてしまうと、余計な費用がかかりますか？
であれば、クロスリージョン間通信を避けるには、どのように設計すればよいですか？

逆に、どう設計構築してしまうと、
クロスリージョンで余分な費用が発生してしまうことになりますか？

この場合のクロスリージョン間通信というのは
自社側だけの話か、他社も絡むことがありえますか？

AZコードではなくAZ IDを意識する必要がありますよね？


[質問-7]　
PrivateLinkのCustomer側は、
PrivateLinkのvpcエンドポイントのプライベートIPに到達さえできれば、
Provider側サービスを利用できる、という理解は正しいか？


[質問-8]　 InterfaceエンドポイントのプライベートIPをDNSで伝達する方法は、どうするのがベストか？

dnsはどのように構築するのがベストですか？
blackbeltをみたところ、
リージョナルDNS名、ゾーナルDNS名、プライベートDNS名の３種類あるみたいですが、
各通信のクライアントは、どのDNS名を宛先として指定すべきですか？

前提として、
自社中継アカウントはマルチAZ構成になっているが、
AZ障害がない限りは、AZ１つにAutoScaling有効のEC2(SFTPクライアント)が1台、存在するのみである。
これを、Lambdaで監視し、
障害あれば、もう一方のAZにEC2クライアントを作成する設計になっている。

[補足]クライアントに宛先を設定する方法は、以下４つがある認識です
  1. InterfaceエンドポイントのリージョナルDNS名
  2. InterfaceエンドポイントのゾーナルDNS名
  3. InterfaceエンドポイントのプライベートDNS名
    - ◎サービスが元々持っている Public DNS 名 を、VPC Endpoint 経由で Private IP に向けて上書き解決する
  4. InterfaceエンドポイントのプライベートIP


[質問-9]
オンプレにも
InterfaceエンドポイントのプライベートIPまでの到達性を持たせるには、どのように構築すべき？

  オンプレミスネットワークからアクセスする場合、Route53 Resolver endpoint と Resolver ルールを使用する必要がある？
  これはどういうことですか？


[質問-10]
PrivateLink周りのセキュリティグループや
NLBにはどのような通信を通すように設定すればよいですか？

